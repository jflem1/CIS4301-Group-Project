WITH date_ranges AS (
    SELECT
        (2000-2000)*12 + 1 AS start_period,
        (2019-2000)*12 + 1 AS end_period
    FROM dual
)
SELECT
    EXTRACT(YEAR FROM STARTTIME) AS Year,
    EXTRACT(MONTH FROM STARTTIME) AS Month,
    AVG(SEVERITY) AS AverageSeverity,
    COUNT(SEVERITY) AS TotalNumberOfCrashes,
    AVG(DISTANCEAFFECTED) as AverageDistanceAffected,
    DistanceRange
FROM
(
WITH filtered_time AS(
    SELECT
        t.ACCIDENTID,
        t.STARTTIME
    FROM
        MICHAELBENNIE.TIME t,
        date_ranges dr
    WHERE
        ((EXTRACT(YEAR FROM t.STARTTIME)-2000)*12 + EXTRACT(MONTH FROM t.STARTTIME)) BETWEEN dr.start_period AND dr.end_period
)
SELECT
CASE
    WHEN 7917.5 * ASIN(SQRT(
        SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) +
        COS(LOCSTARTLATITUDE * 0.017453292519943295) * COS(AP.LATITUDE * 0.017453292519943295) *
        SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2)
    )) < 2 THEN '0-2 miles'
    WHEN 7917.5 * ASIN(SQRT(
        SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) +
        COS(LOCSTARTLATITUDE * 0.017453292519943295) * COS(AP.LATITUDE * 0.017453292519943295) *
        SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2)
    )) < 4 THEN '2-4 miles'
    WHEN 7917.5 * ASIN(SQRT(
        SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) +
        COS(LOCSTARTLATITUDE * 0.017453292519943295) * COS(AP.LATITUDE * 0.017453292519943295) *
        SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2)
    )) < 6 THEN '4-6 miles'
    WHEN 7917.5 * ASIN(SQRT(
        SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) +
        COS(LOCSTARTLATITUDE * 0.017453292519943295) * COS(AP.LATITUDE * 0.017453292519943295) *
        SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2)
    )) < 8 THEN '6-8 miles'
    WHEN 7917.5 * ASIN(SQRT(
        SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LATITUDE - LOCSTARTLATITUDE) * 0.017453292519943295) / 2) +
        COS(LOCSTARTLATITUDE * 0.017453292519943295) * COS(AP.LATITUDE * 0.017453292519943295) *
        SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2) * SIN(((AP.LONGITUDE - LOCSTARTLONGITUDE) * 0.017453292519943295) / 2)
    )) < 10 THEN '8-10 miles'
    ELSE 'Over 10 miles'
END AS DistanceRange,
    A.SEVERITY,
    A.DISTANCEAFFECTED,
    T.STARTTIME as STARTTIME
FROM filtered_time ft
INNER JOIN michaelbennie.accident a ON ft.ACCIDENTID = a.ID
INNER JOIN MICHAELBENNIE.TIME T on A.ID = T.ACCIDENTID
INNER JOIN MICHAELBENNIE.Location L ON A.LocStartLatitude = L.StartLatitude AND A.LocStartLongitude = L.StartLongitude
INNER JOIN MICHAELBENNIE.Airport AP ON L.AirportICAOCode = AP.ICAOCode)
GROUP BY
    EXTRACT(YEAR FROM STARTTIME),
    EXTRACT(MONTH FROM STARTTIME),
    DistanceRange
ORDER BY
    Year,
    Month;




--ORDER BY DistanceInKm DESC;


--0.01745329is PI/180 12742z
--outpus in KM

